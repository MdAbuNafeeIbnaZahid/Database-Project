CREATE OR REPLACE TRIGGER CORRECT_DEPARTMENT_NAME
BEFORE INSERT
ON DEPT
FOR EACH ROW
DECLARE
BEGIN
	:NEW.DEPARTMENT_NAME := UPPER(:NEW.DEPARTMENT_NAME) ;
END ;
/




CREATE OR REPLACE TRIGGER INITIAL_DEPT_HEAD_INSERT
AFTER INSERT
ON DEPT
FOR EACH ROW
DECLARE
	CNT NUMBER;
BEGIN
	--:NEW.DEPARTMENT_NAME := UPPER(:NEW.DEPARTMENT_NAME) ;
	CNT := COUNT_OF_DEPT_ID_IN_LOG( :NEW.DEPARTMENT_ID );
	IF CNT <= 0 THEN
		INSERT INTO DEPARTMENT_HEAD_LOG VALUES(:NEW.DEPARTMENT_ID, null, SYSDATE, null);
	END IF;
END ;
/


CREATE OR REPLACE TRIGGER DEPT_HEAD_LOG_UPDATE
BEFORE UPDATE
OF HEAD_ID
ON DEPT
FOR EACH ROW
DECLARE
	MY_SYS_DATE DATE;
	D_ID NUMBER;
	RECENT_START_DATE DATE;
BEGIN
	MY_SYS_DATE := SYSDATE;
	SELECT DEPARTMENT_ID, MAX(START_DATE) INTO D_ID, RECENT_START_DATE
	FROM DEPARTMENT_HEAD_LOG
	GROUP BY DEPARTMENT_ID
	HAVING DEPARTMENT_ID = :NEW.DEPARTMENT_ID;
	
	/*
	UPDATE DEPARTMENT_HEAD_LOG 
	SET END_DATE = MY_SYS_DATE
	WHERE DEPARTMENT_ID = D_ID, START_DATE = RECENT_START_DATE;
	*/
	DELETE FROM DEPARTMENT_HEAD_LOG 
	WHERE DEPARTMENT_ID = D_ID AND START_DATE = RECENT_START_DATE;
	INSERT INTO DEPARTMENT_HEAD_LOG VALUES(D_ID, :OLD.HEAD_ID, RECENT_START_DATE, SYSDATE);
	INSERT INTO DEPARTMENT_HEAD_LOG VALUES(D_ID, :NEW.HEAD_ID, SYSDATE, null);
END ;
/



CREATE OR REPLACE TRIGGER DEPT_HEAD_LOG_UPDATE
BEFORE UPDATE
OF HEAD_ID
ON DEPT
FOR EACH ROW
DECLARE
	MY_SYS_DATE DATE;
	D_ID NUMBER;
	RECENT_START_DATE DATE;
BEGIN
	MY_SYS_DATE := SYSDATE;
	SELECT DEPARTMENT_ID, MAX(START_DATE) INTO D_ID, RECENT_START_DATE
	FROM DEPARTMENT_HEAD_LOG
	GROUP BY DEPARTMENT_ID
	HAVING DEPARTMENT_ID = :NEW.DEPARTMENT_ID;
	
	
	UPDATE DEPARTMENT_HEAD_LOG 
	SET END_DATE = MY_SYS_DATE
	WHERE DEPARTMENT_ID = D_ID AND START_DATE = RECENT_START_DATE;
	/*
	DELETE FROM DEPARTMENT_HEAD_LOG 
	WHERE DEPARTMENT_ID = D_ID AND START_DATE = RECENT_START_DATE;
	INSERT INTO DEPARTMENT_HEAD_LOG VALUES(D_ID, :OLD.HEAD_ID, RECENT_START_DATE, SYSDATE);
	*/
	INSERT INTO DEPARTMENT_HEAD_LOG VALUES(D_ID, :NEW.HEAD_ID, SYSDATE, null);
END ;
/